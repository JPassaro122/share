
setwd("~/ds/nppes")

library(dplyr) 
library(tidyverse)
library(ggplot2)
library(tmap)
library(leaflet)
library(tidyr)
library(data.table)
library(viridis)
library(caret)
library(Metrics)
library(sf)
options(scipen = 999)

#This step brings in a shape file for county mapping#

mymap <- st_read("county_shape/cb_2018_us_county_500k.shp", stringsAsFactors = FALSE)%>%
  mutate(fips = GEOID)

#The following steps reads in the CDC Social Vulnerability 2018 data file#

spaceless <- function(x) {colnames(x) <- gsub(" ", "_", colnames(x));x}

svi <- read_csv("SVI2018_US_COUNTY.csv")
names(svi) <- tolower(names(svi))
svi <- spaceless(svi)%>%
  filter(fips != '35039')%>%
  mutate(pct_uninsur = ep_uninsur,
         pct_pov = ep_pov, 
         pct_enemp = ep_unemp, 
         per_cap_inc = ep_pci,
         pct_nohsdp = ep_nohsdp,
         pct_age65 = ep_age65,
         pct_age17 = ep_age17, 
         pct_disabl = ep_disabl, 
         pct_sngpnt = ep_sngpnt,
         pct_minrty = ep_minrty, 
         pct_limeng = ep_limeng, 
         pct_munit = ep_munit, 
         pct_mobile = ep_mobile, 
         pct_crowd = ep_crowd, 
         pct_noveh = ep_noveh, 
         pct_groupq = ep_groupq)%>%
  select(fips, e_totpop, rpl_theme1, rpl_theme2, rpl_theme3, rpl_theme4, rpl_themes,
       spl_theme1, spl_theme2, spl_theme3, spl_theme4, spl_themes, epl_pov, epl_unemp,
       epl_pci, epl_nohsdp, epl_age65, epl_age17, epl_disabl, epl_sngpnt, epl_minrty, 
       epl_limeng, epl_munit, epl_mobile, epl_crowd, epl_noveh, epl_groupq, pct_uninsur,
       pct_pov, pct_enemp, per_cap_inc, pct_nohsdp,pct_age65, pct_age17, pct_disabl, 
       pct_sngpnt,pct_minrty, pct_limeng, pct_munit, pct_mobile, pct_crowd, pct_noveh, 
       pct_groupq)
svi[svi == -999] <- 0
svi[svi == 999] <- 0



#The following steps reads in the CMS Multiple Chronic Condition 2018 File#

cms_mcc <- read_csv("mc_cc_2018.csv")%>%
  select(state, county_name, cnty_fips,	B65_1CC, B65_23CC, B65_45CC, B65_6PCC)
cms_mcc <- spaceless(cms_mcc)%>%
  mutate(fips = sprintf("%05d", cnty_fips))
names(cms_mcc) <- tolower(names(cms_mcc))

#The following step reads in the CDC Death Rate file for Diabetes, CVD & CKD#

chrondeath <- read_csv("chron_cond_2018.csv")
chrondeath <- spaceless(chrondeath)%>%
  mutate(fips = sprintf("%05d", cnty_code))%>%
  select(fips, state, deaths, crude_rate, age_adj_rate, calc_rate, population)

#The following steps read in data required to map pcps and specialist from NPPES file to County#

zipxwalk <- read_csv("zip_county_xwalk.csv")
zipxwalk <- spaceless(zipxwalk)%>%
  mutate(zip5 = zip, fips = county)

specialty <- read_csv("taxonomy_specialty.csv")
specialty <- spaceless(specialty)%>%
  filter(nchar(taxonomy)>0)

npi_name <- fread("npidata_pfile_20050523-20220710.csv", 
                  select = c("NPI",
                             "Provider Business Practice Location Address Postal Code",
                             "NPI Deactivation Date",
                             "Healthcare Provider Taxonomy Code_1",
                             "Healthcare Provider Taxonomy Code_2",
                             "Healthcare Provider Taxonomy Code_3"))

npi_name <- spaceless(npi_name)
names(npi_name) <- tolower(names(npi_name))

#The following steps separate the relevant PCP and Specialist taxonomies for #
#the first 3 taxonomies and then appends them to each other to get best count#

tax1 <- npi_name%>%
  filter(!is.null(npi_deactivation_date) & 
           nchar(healthcare_provider_taxonomy_code_1)>0 &
           nchar(provider_business_practice_location_address_postal_code)>0)%>%
  select(npi, provider_business_practice_location_address_postal_code, healthcare_provider_taxonomy_code_1)%>%
  rename(zipcode = provider_business_practice_location_address_postal_code,
         taxonomy = healthcare_provider_taxonomy_code_1)%>%
  mutate(zip5 = substr(zipcode,1,5))

tax2 <- npi_name%>%
  filter(!is.null(npi_deactivation_date) & 
           nchar(healthcare_provider_taxonomy_code_2)>0 &
           nchar(provider_business_practice_location_address_postal_code)>0)%>%
  select(npi, provider_business_practice_location_address_postal_code, healthcare_provider_taxonomy_code_1)%>%
  rename(zipcode = provider_business_practice_location_address_postal_code,
         taxonomy = healthcare_provider_taxonomy_code_1)%>%
  mutate(zip5 = substr(zipcode,1,5))

tax3 <- npi_name%>%
  filter(!is.null(npi_deactivation_date) & 
           nchar(healthcare_provider_taxonomy_code_3)>0 &
           nchar(provider_business_practice_location_address_postal_code)>0)%>%
  select(npi, provider_business_practice_location_address_postal_code, healthcare_provider_taxonomy_code_1)%>%
  rename(zipcode = provider_business_practice_location_address_postal_code,
         taxonomy = healthcare_provider_taxonomy_code_1)%>%
  mutate(zip5 = substr(zipcode,1,5))


taxfinal <- rbind(tax1, tax2, tax3)%>%
  select(npi, taxonomy, zip5)%>%
  left_join(specialty, by=c("taxonomy"))%>%
  left_join(zipxwalk, by=c("zip5"))

#The following steps summarize pcp count, specialist count and hospital count by County#

fips_pcp <- taxfinal%>%
  filter(specialty_group=='PCP')%>%
  group_by(fips)%>%
  summarize(pcps = n_distinct(npi))

fips_spec <- taxfinal%>%
  filter(specialty_group=='Specialty')%>%
  group_by(fips)%>%
  summarize(specs = n_distinct(npi))

fips_hosp <- taxfinal%>%
  filter(specialty_group=='Hospitals')%>%
  group_by(fips)%>%
  summarize(hosp = n_distinct(npi))

#All files are now joined to the chronic death file#

chron_prov <- chrondeath%>%
  left_join(cms_mcc, by=c("fips"))%>%
  left_join(svi, by=c("fips"))%>% 
  left_join(fips_pcp, by=c("fips"))%>%
  left_join(fips_spec, by=c("fips"))%>%
  left_join(fips_hosp, by=c("fips"))

#The previous file is left joined to the mapping shape file, Continental US is kept,#
#and additional value added fields calculated                                       #

mymap_mydata <- mymap%>%
  left_join(chron_prov, by=c("fips"))%>%
  mutate(b65_1cc = ifelse(is.na(b65_1cc),
                          median(b65_1cc, na.rm = T),
                          b65_1cc),
         b65_23cc = ifelse(is.na(b65_23cc),
                          median(b65_23cc, na.rm = T),
                          b65_23cc),
         calc_rate_f = ifelse(is.na(calc_rate),
                           median(calc_rate, na.rm = T),
                           calc_rate),
         pcp_perk = pcps*1000/population,
         pcp_pctl = ntile(pcp_perk,100)/100,
         Chron_Dth_Pctl = ntile(calc_rate_f,100)/100,
         pcp_pctl_i = 1-pcp_pctl,
         spec_perk = specs*1000/population,
         spec_pctl = ntile(spec_perk,100)/100,
         spec_pctl_i = 1-spec_pctl,
         Chron_Dth_Cat = case_when(Chron_Dth_Pctl >= .8 ~ 80, 
                                   Chron_Dth_Pctl <= .2 ~ 20,
                                   TRUE ~ 50))%>%
  mutate_if(is.numeric, ~replace(., is.na(.), 0))

install.packages("usmap")
library(usmap)





#The following mapping gives us an idea of how Social Vulnerability Relates to#
#Chronic Condition death rates                                               #

plot_usmap(data = mymap_mydata, values = "Chron_Dth_Pctl", color = "black") + 
  scale_fill_viridis(name="Chronic Dis\nDeath Pctl", 
                     alpha = 1,
                     begin = 0,
                     end = 1,
                     direction = 1,
                     option = "turbo",
                     aesthetics = "fill")+
  theme_void(base_size = 14,
             base_family = "",
             base_line_size = base_size/28,
             base_rect_size = base_size/28) +
  labs(title = "2018 Chronic Condition Mortality Rank",
       subtitle = "Diabetes, CVD & Kidney Disease")
theme(legend.position = "right")

plot_usmap(data = mymap_mydata, values = "rpl_themes", color = "black") + 
  scale_fill_viridis(name="Social\nVulnerability\nPctl", 
                     alpha = 1,
                     begin = 0,
                     end = 1,
                     direction = 1,
                     option = "turbo",
                     aesthetics = "fill")+
  theme_void(base_size = 14,
             base_family = "",
             base_line_size = base_size/28,
             base_rect_size = base_size/28) +
  labs(title = "2018 CDC Overall Social Vulnerability Composite")+
  theme(legend.position = "right")

plot_usmap(data = mymap_mydata, values = "rpl_theme3", color = "black") + 
  scale_fill_viridis(name="Minority &\nLanguage Pctl", 
                     alpha = 1,
                     begin = 0,
                     end = 1,
                     direction = 1,
                     option = "turbo",
                     aesthetics = "fill")+
  theme_void(base_size = 14,
             base_family = "",
             base_line_size = base_size/28,
             base_rect_size = base_size/28) +
  labs(title = "2018 Minority & Language Vulnerability Composite")+
  theme(legend.position = "right")



zero_remove <- mymap_mydata%>%
  filter(calc_rate > 0 & calc_rate < 650)

drop_geo=st_drop_geometry(zero_remove)

drop_geo$id <- 1:nrow(drop_geo)
train <- drop_geo %>% dplyr::sample_frac(.7)
#drop_geo=st_drop_geometry(zero_remove)
test  <- dplyr::anti_join(drop_geo, train, by = 'id')



model_full <- lm(calc_rate ~ pct_uninsur+ pct_pov + pct_enemp + per_cap_inc + pct_nohsdp + 
                   pct_age65 + pct_age17 + pct_disabl + pct_sngpnt + pct_minrty + pct_limeng + 
                   pct_munit + pct_mobile + pct_crowd + pct_noveh + pct_groupq + spec_perk + 
                   pcp_perk, data = train)
summary(model_full)

model_sel <- lm(calc_rate ~ pct_uninsur+ pct_pov + pct_nohsdp + 
                  pct_age17 + pct_disabl + pct_sngpnt + pct_minrty + pct_limeng +
                  pct_mobile + pct_crowd, data = train)
summary(model_sel)



model_full_poly <- lm(calc_rate ~ poly(pct_uninsur,3) + poly(pct_pov,3) + poly(pct_enemp,3) + 
                   poly(per_cap_inc,3) + poly(pct_nohsdp,3) + poly(pct_age65,3) + 
                   poly(pct_age17,3) + poly(pct_disabl,3) + poly(pct_sngpnt,3) + 
                   poly(pct_minrty,3) + poly(pct_limeng,3) + poly(pct_munit,3) + 
                   poly(pct_mobile,3) + poly(pct_crowd,3) + poly(pct_noveh,3) + 
                   poly(pct_groupq,3) + poly(spec_perk,3) + poly(pcp_perk,3), data = train)
summary(model_full_poly)


model_sel_poly <- lm(calc_rate ~ pct_uninsur + poly(pct_pov,2) + 
                       poly(pct_nohsdp,2) + pct_minrty
                       pct_age17 + pct_disabl + 
                       pct_sngpnt + poly(pct_limeng,2) + pct_crowd + pct_noveh, data = train)
summary(model_sel_poly)



test$poly_predict = predict(model_sel_poly, test)
test$linear_predict = predict(model_sel, test)

R2_linear <- R2(test$linear_predict, test$calc_rate)
R2_poly <- R2(test$poly_predict, test$calc_rate)

print(R2_linear)
print(R2_poly) 

mae_linear <- mae(actual = test$calc_rate, predicted = test$linear_predict)
mae_poly <- mae(actual = test$calc_rate, predicted = test$poly_predict)

mae(actual = y, predicted = y_hat)

RMSE_linear <- RMSE(test$calc_rate, test$linear_predict)
RMSE_poly <- RMSE(test$calc_rate, test$poly_predict)

print(RMSE_linear)
print(RMSE_poly)

rrse_linear <- rrse(actual = test$calc_rate, predicted = test$linear_predict)

SI_linear <- (RMSE_linear/mean(test$calc_rate))
SI_polynomial <- (RMSE_poly/mean(test$calc_rate))

normRMSE_linear <- RMSE_linear/(max(test$calc_rate)-min(test$calc_rate))
normRMSE_poly <- RMSE_poly/(max(test$calc_rate)-min(test$calc_rate))

print(normRMSE_linear)
print(normRMSE_poly)

var.test(test$calc_rate, test$linear_predict, alternative = "two.sided")
var.test(test$calc_rate, test$poly_predict, alternative = "two.sided")

ggplot(data = test, aes(x=calc_rate, y=linear_predict))+
  geom_point(color = "gray") +
  #geom_abline(intercept = 0, slope = 1, color = "grey", size=1)+
  scale_y_continuous(name="Predicted \n", limits=c(100, 500), breaks = c(100, 200, 300, 400, 500)) +
  scale_x_continuous(name="Actual \n", limits=c(100, 600), breaks = c(100, 200, 300, 400, 500, 600)) +
  #geom_smooth(aes(y = poly_predict),color = "green", size=3) + 
  geom_smooth(aes(y = linear_predict), se=FALSE, color = "blue", size=2) + 
  theme_classic()  +
  labs(title = "Optimized Linear Regression Model",
       subtitle = "Actual Vs. Predicted Chronic Disease Deaths / 100,000")

ggplot(data = test, aes(x=calc_rate, y=poly_predict))+
  geom_point(color = "gray") +
  #geom_abline(intercept = 0, slope = 1, color = "grey", size=1)+
  scale_y_continuous(name="Predicted \n", limits=c(100, 500), breaks = c(100, 200, 300, 400, 500)) +
  scale_x_continuous(name="Actual \n", limits=c(100, 600), breaks = c(100, 200, 300, 400, 500, 600)) +
  geom_smooth(aes(y = poly_predict), se=FALSE, color = "black", size=3) + 
  geom_smooth(aes(y = linear_predict), se=FALSE, color = "blue", size=2) + 
  theme_classic()  +
  labs(title = "Optimized Linear & Polynomial Regression Models",
       subtitle = "Actual Vs. Predicted Chronic Disease Deaths / 100,000") +
  annotate("text", x=450, y=425, label = "Polynomial Model", size=5, colour = "black", hjust=0, fontface = "bold") +
  annotate("text", x=450, y=325, label = "Linear Model", size=5, colour = "blue", hjust=0, fontface = "bold")
  

mymap_mydata$poly_predict = predict(model_sel_poly, mymap_mydata)
mymap_mydata$linear_predict = predict(model_sel, mymap_mydata)


mymap_mydata_pred <- mymap_mydata%>%
  filter(STATEFP != '02' & STATEFP != '15' & STATEFP != '72' &
           STATEFP != '66' & STATEFP != '69' & STATEFP != '78' &
           STATEFP != '60')%>%
  mutate(pred_rate_linear = ifelse(is.na(linear_predict),
                              median(linear_predict, na.rm = T),
                              calc_rate),
         Chron_Dth_Pctl_pred = ntile(pred_rate_linear,100)/100)%>%
  mutate_if(is.numeric, ~replace(., is.na(.), 0))


ggplot(mymap_mydata_pred) +
  geom_sf(aes(geometry = geometry, fill = Chron_Dth_Pctl_pred))+
  scale_fill_viridis(name="Chronic Dis\nDeath Pctl", 
                     alpha = 1,
                     begin = 0,
                     end = 1,
                     direction = 1,
                     option = "turbo",
                     aesthetics = "fill")+
  theme_void(base_size = 14,
             base_family = "",
             base_line_size = base_size/28,
             base_rect_size = base_size/28) +
  labs(title = "2018 Predicted Chronic Condition Death Percent Rank",
       subtitle = "Diabetes, CVD & Kidney Disease")








ggplot(data = test, aes(x=calc_rate, y=pct_sngpnt))+
  geom_point(color = "blue") +
  geom_smooth(color = "red", size=1) +
  scale_y_continuous(name="% Single Parent Household\n", limits=c(0, 20), breaks = c(0, 5, 10, 15, 20)) +
  scale_x_continuous(name="\nChronic Death Rate", limits=c(100, 700), breaks = c(100, 200, 300, 400, 500, 600, 700)) +
  theme_classic() 

ggplot(data = test, aes(x=calc_rate, y=pct_limeng))+
  geom_point(color = "blue") +
  geom_smooth(color = "red", size=1) +
  scale_y_continuous(name="% Limited English\n", limits=c(0, 30), breaks = c(0, 5, 10, 15, 20, 25, 30)) +
  scale_x_continuous(name="\nChronic Death Rate", limits=c(100, 700), breaks = c(100, 200, 300, 400, 500, 600, 700)) +
  theme_classic() 

ggplot(data = test, aes(x=calc_rate, y=pct_nohsdp))+
  geom_point(color = "blue") +
  geom_smooth(color = "red", size=1) +
  scale_y_continuous(name="% Limited English\n", limits=c(0, 50), breaks = c(0, 10, 20, 30, 40, 50)) +
  scale_x_continuous(name="\nChronic Disease Death Rate", limits=c(100, 700), breaks = c(100, 200, 300, 400, 500, 600, 700)) +
  theme_classic() 

ggplot(data = test, aes(x=calc_rate, y=pct_age17))+
  geom_point(color = "blue") +
  geom_smooth(color = "red", size=1) +
  #scale_y_continuous(name="% Limited English\n", limits=c(0, 30), breaks = c(0, 5, 10, 15, 20, 25, 30)) +
  scale_x_continuous(name="\nChronic Disease Death Rate", limits=c(100, 700), breaks = c(100, 200, 300, 400, 500, 600, 700)) +
  theme_classic() 


ggplot(data = zero_remove, aes(x=calc_rate, y=rpl_themes))+
  geom_point(color = "gray") +
  #geom_smooth(se=FALSE, color = "red", size=2) +
  scale_y_continuous(name="CDC Social Vulnerability Composites\n", limits=c(0, 1), breaks = c(0, .25, .50, .75, 1)) +
  scale_x_continuous(name="\nChronic Disease Death Rate Per 100,000", limits=c(100, 700), breaks = c(100, 200, 300, 400, 500, 600, 700)) +
  geom_smooth(aes(y = rpl_theme1), se=FALSE, color = "green", size=1) + 
  annotate("text", x=500, y=.99, label = "Socioeconomic", size=4, colour = "green", hjust=0, fontface = "bold")+
  geom_smooth(aes(y = rpl_theme2), se=FALSE, color = "Black", size=1) + 
  annotate("text", x=500, y=.82, label = "Household & Disability", size=4, colour = "black", hjust=0, fontface = "bold")+
  geom_smooth(aes(y = rpl_theme4), se=FALSE, color = "Orange", size=1) + 
  annotate("text", x=500, y=.63, label = "Housing Type &\nTransportation", size=4, colour = "Orange", hjust=0, fontface = "bold")+
  geom_smooth(aes(y = rpl_theme3), se=FALSE, color = "Blue", size=1) +
  annotate("text", x=500, y=.48, label = "Minority & Language", size=4, colour = "blue", hjust=0, fontface = "bold")+
  theme_classic()  +
  labs(title = "2018 CDC Social Vulnerability Vs. Chronic Disease Mortality")

add_geo_test <- test%>%
  left_join(mymap_mydata, by=c("fips"))

ggplot(add_geo_test) +
  geom_sf(aes(geometry = geometry, fill = calc_rate.x))+
  scale_fill_viridis(name="Chronic Dis\nDeath/100,000", 
                     alpha = 1,
                     begin = 0,
                     end = 1,
                     direction = 1,
                     option = "turbo",
                     aesthetics = "fill")+
  theme_void(base_size = 14,
             base_family = "",
             base_line_size = base_size/28,
             base_rect_size = base_size/28) +
  labs(title = "2018 Test Data Chronic Condition Deaths/100,000",
       subtitle = "Actual")

ggplot(add_geo_test) +
  geom_sf(aes(geometry = geometry, fill = poly_predict))+
  scale_fill_viridis(name="Chronic Dis\nDeath/100,000", 
                     alpha = 1,
                     begin = 0,
                     end = 1,
                     direction = 1,
                     option = "turbo",
                     aesthetics = "fill")+
  theme_void(base_size = 14,
             base_family = "",
             base_line_size = base_size/28,
             base_rect_size = base_size/28) +
  labs(title = "2018 Test Data Chronic Condition Deaths/100,000",
       subtitle = "Predicted")

test1 <- test%>%
  filter(poly_predict > 450 | poly_predict < 500 | calc_rate > 450 | calc_rate < 500)%>%
  arrange(calc_rate)

test3 <- mymap_mydata%>%
  filter(GEOID == '01127')

plot_usmap(data = mymap_mydata, values = "epl_pov", color = "black") + 
  scale_fill_viridis(name="Poverty\nPctl", 
                     alpha = 1,
                     begin = 0,
                     end = 1,
                     direction = 1,
                     option = "turbo",
                     aesthetics = "fill")+
  theme_void(base_size = 14,
             base_family = "",
             base_line_size = base_size/28,
             base_rect_size = base_size/28) +
  labs(title = "2018 Poverty Vulnerability")+
  theme(legend.position = "right")

plot_usmap(data = mymap_mydata, values = "epl_nohsdp", color = "black") + 
  scale_fill_viridis(name="No HS Diploma\nPctl", 
                     alpha = 1,
                     begin = 0,
                     end = 1,
                     direction = 1,
                     option = "turbo",
                     aesthetics = "fill")+
  theme_void(base_size = 14,
             base_family = "",
             base_line_size = base_size/28,
             base_rect_size = base_size/28) +
  labs(title = "2018 High School Diploma Vulnerability")+
  theme(legend.position = "right")



